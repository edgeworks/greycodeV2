<!DOCTYPE html>
<html>
<head>
  <title>Greycode Demo</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <h1>Greycode â€“ Sysmon Threat Enrichment</h1>

    <div class="statusbar">
      {% if vt_enabled %}
        <div class="banner enabled">VirusTotal checks: ENABLED</div>
      {% else %}
        <div class="banner disabled">VirusTotal checks: DISABLED (training mode)</div>
      {% endif %}

      <div class="metrics">
        <span><b>VT queue:</b> {{ vt_queue_len }}</span>
        <span><b>Staged candidates:</b> {{ staged_candidates }}</span>
        <span><b>Known hashes:</b> {{ total_hashes or "-" }}</span>
      </div>
    </div>
  </header>

  <main>
    {% block content %}{% endblock %}
  </main>

  <script>
    (function () {
      // -----------------------------
      // Column toggles
      // -----------------------------
      function setColVisible(col, visible) {
        document.querySelectorAll(".col-" + col).forEach(function (el) {
          el.style.display = visible ? "" : "none";
        });
        localStorage.setItem("greycode_col_" + col, visible ? "1" : "0");
      }

      document.querySelectorAll("input[type=checkbox][data-col]").forEach(function (cb) {
        var col = cb.getAttribute("data-col");
        var saved = localStorage.getItem("greycode_col_" + col);

        if (saved !== null) cb.checked = (saved === "1");
        setColVisible(col, cb.checked);

        cb.addEventListener("change", function () {
          setColVisible(col, cb.checked);
        });
      });

      // -----------------------------
      // Bulk selection + delete confirm
      // -----------------------------
      var selectAll = document.getElementById("selectAll");
      if (selectAll) {
        selectAll.addEventListener("change", function () {
          document.querySelectorAll("input.rowSelect").forEach(function (cb) {
            cb.checked = selectAll.checked;
          });
        });
      }

      var bulkForm = document.getElementById("bulkForm");
      var bulkAction = document.getElementById("bulkAction");
      if (bulkForm && bulkAction) {
        bulkForm.addEventListener("submit", function (e) {
          // Count selected rows
          var selectedCount = document.querySelectorAll("input.rowSelect:checked").length;

          if (selectedCount === 0) {
            // Nothing selected; prevent no-op submit
            e.preventDefault();
            return;
          }

          if (bulkAction.value === "delete") {
            if (!confirm("Delete " + selectedCount + " entries? This cannot be undone.")) {
              e.preventDefault();
            }
          }
        });
      }
    })();
  </script>


</body>
</html>
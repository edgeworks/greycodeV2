{% extends "base.html" %}
{% block content %}

<p><b>Known hashes:</b> {{ total_hashes }}</p>

<form method="get" class="controls">
  <label>Status:
    <select name="status">
      {% for s in ["ALL","RED","ERROR","GREY","GREEN"] %}
        <option value="{{ s }}" {% if status == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </label>

  <label>Search:
    <input type="text" name="q" value="{{ q }}" placeholder="sha256 / computer / path">
  </label>

  <label>Sort:
    <select name="sort">
      <option value="last_seen" {% if sort=="last_seen" %}selected{% endif %}>Last seen</option>
      <option value="count_total" {% if sort=="count_total" %}selected{% endif %}>Count</option>
      <option value="status" {% if sort=="status" %}selected{% endif %}>Status</option>
      <option value="vt_state" {% if sort=="vt_state" %}selected{% endif %}>VT State</option>
    </select>
  </label>

  <label>Order:
    <select name="order">
      <option value="desc" {% if order=="desc" %}selected{% endif %}>Desc</option>
      <option value="asc" {% if order=="asc" %}selected{% endif %}>Asc</option>
    </select>
  </label>

  <label>Page size:
    <select name="page_size">
      {% for ps in [50,100,200,500,1000] %}
        <option value="{{ ps }}" {% if page_size == ps %}selected{% endif %}>{{ ps }}</option>
      {% endfor %}
    </select>
  </label>

  <!-- reset to first page on new filter -->
  <input type="hidden" name="page" value="1">

  <button type="submit">Apply</button>
</form>

<div class="col-toggles">
  <span class="muted">Columns:</span>
  <label><input type="checkbox" data-col="vtstate" checked> VT State</label>
  <label><input type="checkbox" data-col="vtred" checked> VT Red</label>
  <label><input type="checkbox" data-col="count" checked> Count</label>
  <label><input type="checkbox" data-col="lastseen" checked> Last Seen</label>
  <label><input type="checkbox" data-col="computer" checked> Computer</label>
  <label><input type="checkbox" data-col="image" checked> Image</label>
</div>

<p><b>Results:</b> {{ total }} (showing {{ rows|length }})</p>

<form ... id="bulkForm">
  <form method="post" action="/ui/bulk_action" class="bulkbar" id="bulkForm">
    <label class="bulkitem">
      <input type="checkbox" id="selectAll">
      Select all on page
    </label>

    <label class="bulkitem">
      Action:
      <select name="action" id="bulkAction">
        <option value="accept">Accept (Benign)</option>
        <option value="escalate">Escalate</option>
        <option value="clear">Clear disposition</option>
        <option value="recheck">Recheck (VT)</option>
        <option value="delete">Delete</option>
      </select>
    </label>

    <label class="bulkitem">
      Ticket (for escalate):
      <input type="text" name="ticket_id" id="bulkTicket" placeholder="INC123456">
    </label>

    <button type="submit" class="bulkitem">Apply to selected</button>
  </form>

  <table>
    <tr>
      <th class="col-sel"></th>
      <th class="col-status">Status</th>
      <th class="col-vtstate">VT State</th>
      <th class="col-count">Count</th>
      <th class="col-lastseen">Last Seen</th>
      <th class="col-computer">Computer</th>
      <th class="col-image">Image</th>
      <th class="col-sha">SHA256</th>
    </tr>

    {% for row in rows %}
    <tr class="{{ row.status }}">
      
      <td class="col-sel">
        <input type="checkbox" name="selected" value="{{ row.sha256 }}" class="rowSelect">
      </td>
      
      <td class="col-status">
        <span class="status-text">{{ row.status }}</span>

        {% if row.status == "RED" and row.vt_malicious and row.vt_malicious|int > 0 %}
          <span class="badge vtred" title="VT malicious engines">{{ row.vt_malicious }}</span>
        {% endif %}
      </td>


      <td class="col-vtstate">
        {% if row.status == "GREY" and row.vt_state %}
          <span class="badge vt-{{ row.vt_state|lower }}">{{ row.vt_state }}</span>
        {% elif row.status == "GREY" %}
          <span class="badge vt-pending">PENDING</span>
        {% else %}
          <span class="muted">-</span>
        {% endif %}
      </td>

      <td class="col-count num">{{ row.count_total }}</td>
      <td class="col-lastseen mono">{{ row.last_seen or "-" }}</td>
      <td class="col-computer" title="{{ row.computer }}">{{ row.computer or "-" }}</td>
      <td class="col-image mono" title="{{ row.image }}">{{ row.image or "-" }}</td>

      <td class="col-sha">
        <a href="/ui/hash/{{ row.sha256 }}">{{ row.sha256[:9] }}â€¦</a>
        <span class="sep">|</span>
        <a href="{{ row.vt_link }}" target="_blank" rel="noopener noreferrer">VT</a>
      </td>
    </tr>
    {% endfor %}
  </table>
</form>

<div class="pager">
  {% if page > 1 %}
    <a href="?status={{status}}&q={{q}}&sort={{sort}}&order={{order}}&page_size={{page_size}}&page={{page-1}}">
      Prev
    </a>
  {% endif %}

  <span>Page {{ page }}</span>

  {% if page * page_size < total %}
    <a href="?status={{status}}&q={{q}}&sort={{sort}}&order={{order}}&page_size={{page_size}}&page={{page+1}}">
      Next
    </a>
  {% endif %}
</div>

{% endblock %}
